<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ITF Technique Builder — Cascading (Stable)</title>
<style>
  :root{color-scheme:light dark}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",sans-serif;background:#0b1220;color:#eaf0ff}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:16px}
  @media(min-width:980px){.grid-2{grid-template-columns:1fr 1fr}}
  .card{background:#0f172a;border:1px solid #1f2937;border-radius:16px;padding:16px}
  h1{margin:4px 0 8px;font-size:22px}
  h2{margin:0 0 12px;font-size:18px}
  .row{display:flex;flex-direction:column;gap:10px}
  .step{display:flex;flex-direction:column;gap:6px}
  label{font-size:13px;color:#cbd5e1}
  select{width:100%;background:#0b1327;color:#e5e7eb;border:1px solid #1f2937;border-radius:12px;padding:10px}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .check{display:inline-flex;gap:6px;align-items:center;background:#0b1327;border:1px solid #1f2937;border-radius:10px;padding:8px 10px;font-size:12px}
  .muted{color:#b8c2d9}
  .out{background:#0b1327;border:1px solid #1f2937;border-radius:12px;padding:12px;margin-top:8px;min-height:44px}
  .hidden{display:none}
  .divider{height:1px;background:#1f2937;margin:8px 0}
  .pill{display:inline-block;border:1px solid #1f2937;border-radius:999px;padding:4px 8px;font-size:12px}
  .err{margin-top:10px;border:1px solid #7f1d1d;background:#2b0f10;color:#fecaca;border-radius:10px;padding:8px 10px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>ITF Technique Builder</h1>

  <div class="grid grid-2">
    <section class="card">
      <h2>Build</h2>
      <div class="row" id="builder">

        <!-- Height -->
        <div class="step">
          <label>Height</label>
          <select id="heightSel"><option value="">Choose…</option></select>
        </div>

        <!-- Stance (before Type) -->
        <div class="step">
          <label>Stance</label>
          <select id="stanceSel"><option value="">Choose…</option></select>
        </div>

        <!-- Technique family -->
        <div class="step">
          <label>Type</label>
          <select id="familySel"><option value="">Choose…</option></select>
        </div>

        <!-- Progressive area -->
        <div id="progressiveArea" class="row"></div>

        <!-- Modifiers -->
        <div class="divider"></div>
        <div class="inline">
          <span class="pill">Modifiers</span>
          <label class="check hidden" id="modFlyingWrap"><input type="checkbox" id="modFlying"> <span>Flying / Twimyo / 뛰며</span></label>
          <label class="check hidden" id="modReverseWrap"><input type="checkbox" id="modReverse"> <span>Reverse / Bandae / 반대</span></label>
        </div>

        <div id="errorBox" class="err hidden"></div>
      </div>
    </section>

    <section class="card">
      <h2>Output</h2>
      <div class="out"><strong>English:</strong> <span id="outEN" class="muted">—</span></div>
      <div class="out"><strong>Romanised:</strong> <span id="outROM" class="muted">—</span></div>
      <div class="out"><strong>Hangul:</strong> <span id="outHAN" class="muted">—</span></div>
    </section>
  </div>
</div>

<script>
/* ================== DATA ================== */
const STANCES = [
  { key:"walking", en:"Walking", rom:"Gunnun", han:"걷는" },
  { key:"l",       en:"L-",      rom:"Niunja", han:"ㄴ자" },
  { key:"sitting", en:"Sitting", rom:"Annun",  han:"앉는" },
  { key:"parallel",en:"Parallel",rom:"Narani", han:"나란히" },
  { key:"fixed",   en:"Fixed",   rom:"Gojung", han:"고정" },
  { key:"closed",  en:"Closed",  rom:"Moa",    han:"모아" },
  { key:"x",       en:"X-",      rom:"Kyocha", han:"교차" },
  { key:"rearfoot",en:"Rear foot",rom:"Dwitbal",han:"뒷발" },
  { key:"vertical",en:"Vertical",rom:"Soojik", han:"수직" },
  { key:"bending", en:"Bending-ready",rom:"Goburyo junbi",han:"구부려 준비" },
  { key:"oneleg",  en:"One-leg", rom:"Waebal", han:"외발" }
];

const HEIGHTS = [
  { key:"high",   en:"High",   rom:"Nopunde", han:"높은데" },
  { key:"middle", en:"Middle", rom:"Kaunde",  han:"가운데" },
  { key:"low",    en:"Low",    rom:"Najunde", han:"낮은데" }
];

const DIR_ALL = [
  { key:"inward",  en:"Inward",   rom:"Anuro",    han:"안으로" },
  { key:"outward", en:"Outward",  rom:"Bakaturo", han:"바깥으로" },
  { key:"upward",  en:"Upward",   rom:"Ollyo",    han:"올려" },
  { key:"downward",en:"Downward", rom:"Naeryo",   han:"내려" },
  { key:"rising",  en:"Rising",   rom:"Chookyo",  han:"축여" }
];

/* Block tool bases + variants */
const BLOCK_TOOL_BASES = [
  { key:"forearm", en:"Forearm", rom:"Palmok", han:"팔목", variants:[
      { key:"inner",  en:"Inner",  rom:"An",     han:"안" },
      { key:"outer",  en:"Outer",  rom:"Bakat",  han:"바깥" }
    ]},
  { key:"knifehand", en:"Knifehand", rom:"Sonkal", han:"손칼", variants:[
      { key:"normal", en:"Normal", rom:"",         han:"" },
      { key:"reverse",en:"Reverse",rom:"Sonkal dung", han:"손칼 등", replaceBase:true }
    ]},
  { key:"palm", en:"Palm", rom:"Sonbadak", han:"손바닥", variants:[
      { key:"normal", en:"Normal", rom:"Sonbadak",      han:"손바닥", replaceBase:true },
      { key:"reverse",en:"Reverse",rom:"Sonbadak dung", han:"손바닥 등", replaceBase:true }
    ]},
  { key:"fist", en:"Fist (X-fist only)", rom:"Joomuk", han:"주먹", variants:[
      { key:"xonly", en:"(X-shape only)", rom:"", han:"" }
    ]}
];

/* Strike tools */
const STRIKE_TOOLS = [
  { key:"elbow",          en:"Elbow",           rom:"Palkup",         han:"팔굽" },
  { key:"knifehand",      en:"Knifehand",       rom:"Sonkal",         han:"손칼" },
  { key:"rev_knifehand",  en:"Reverse knifehand", rom:"Sonkal dung",  han:"손칼 등" },
  { key:"backfist",       en:"Backfist",        rom:"Dung joomuk",    han:"등 주먹" },
  { key:"backhand",       en:"Backhand",        rom:"Dung son",       han:"등손" },
  { key:"palm",           en:"Palm",            rom:"Sonbadak",       han:"손바닥" },
  { key:"rev_palm",       en:"Reverse palm",    rom:"Sonbadak dung",  han:"손바닥 등" },
  { key:"arc_hand",       en:"Arc hand",        rom:"Bandal son",     han:"반달손" }
];

/* Punch styles + tool */
const PUNCH_STYLES = [
  { key:"standard", en:"Punch",           rom:"Jirugi",        han:"지르기" },
  { key:"uppercut", en:"Uppercut punch",  rom:"Ollyo jirugi",  han:"올려 지르기" },
  { key:"vertical", en:"Vertical punch",  rom:"Sewo jirugi",   han:"세워 지르기" },
  { key:"hooking",  en:"Hooking punch",   rom:"Golcho jirugi", han:"걸초 지르기" }
];
const PUNCH_TOOLS = [
  { key:"forefist", en:"Forefist", rom:"Ap joomuk", han:"앞 주먹" }
];

/* Thrust styles + tools */
const THRUST_STYLES = [
  { key:"standard", en:"Thrust",                 rom:"Tulgi",                 han:"찌르기" },
  { key:"upset",    en:"Upset fingertip thrust", rom:"Dwijibo sonkut tulgi", han:"뒤집어 손끝 찌르기" }
];
const THRUST_TOOLS = [
  { key:"fingertips",     en:"Fingertips",     rom:"Sonkut",       han:"손끝" },
  { key:"flat_fingertip", en:"Flat fingertip", rom:"Opun sonkut",  han:"오픈 손끝" }
];

/* Kicks + foot tools */
const KICKS = [
  { key:"front",   en:"Front kick",   rom:"Ap chagi",        han:"앞 차기",   feet:["ball","instep"] },
  { key:"side",    en:"Side kick",    rom:"Yop chagi",       han:"옆 차기",   feet:["footsword"] },
  { key:"turning", en:"Turning kick", rom:"Dollyo chagi",    han:"돌려 차기", feet:["instep","ball"] },
  { key:"back",    en:"Back kick",    rom:"Dwit chagi",      han:"뒷 차기",   feet:[] },
  { key:"revturn", en:"Reverse turning kick", rom:"Bandae dollyo chagi", han:"반대 돌려 차기", feet:["instep","ball"] },
  { key:"hook",    en:"Hook kick",    rom:"Golcho chagi",    han:"걸초 차기", feet:["footsword"] },
  { key:"axe",     en:"Axe kick",     rom:"Naeryo chagi",    han:"내려 차기", feet:[] },
  { key:"twist",   en:"Twisting kick",rom:"Bituro chagi",    han:"비틀어 차기", feet:["footsword"] },
  { key:"stamp",   en:"Stamping kick",rom:"Cha bapgi",       han:"차밟기",   feet:[] },
  { key:"push",    en:"Pushing kick", rom:"Miro chagi",      han:"밀어 차기", feet:["ball"] },
  { key:"check",   en:"Checking kick",rom:"Momchau chagi",   han:"멈춰 차기", feet:[] }
];
const FOOT_TOOLS = [
  { key:"ball",      en:"Ball of foot", rom:"Ap kumchi", han:"앞금치" },
  { key:"instep",    en:"Instep",       rom:"Baldung",   han:"발등" },
  { key:"footsword", en:"Footsword",    rom:"Balkal",    han:"발칼" }
];

/* Block types (direction support declared) */
const BLOCK_TYPES = [
  { key:"standard", en:"Block",        rom:"Makgi",         han:"막기",     dir:true,  tool:true,
    allowedTools:["forearm","knifehand","palm"] },
  { key:"pressing", en:"Pressing block", rom:"Noollo makgi",han:"눌러 막기", dir:false, tool:true,
    allowedTools:["palm","fist"] },
  { key:"sweeping", en:"Sweeping block", rom:"Duro makgi",  han:"들어 막기", dir:true,  tool:true,
    allowedTools:["forearm"] },
  { key:"checking", en:"Checking block", rom:"Momchau makgi",dir:false, tool:true,
    allowedTools:["palm"] },
  { key:"guarding", en:"Guarding block", rom:"Daebi makgi", han:"대비 막기", dir:false, tool:true,
    allowedTools:["forearm","knifehand"] },
  { key:"circular", en:"Circular block", rom:"Dollimyo makgi", han:"돌림요 막기", dir:true, tool:true,
    allowedTools:["forearm","knifehand"] },
  { key:"wshape",   en:"W-shape block", rom:"San makgi",    han:"산 막기",   dir:false, tool:false },
  { key:"ushape",   en:"U-shape block", rom:"Digutja makgi",han:"디귿자 막기",dir:false, tool:false },
  { key:"wedging",  en:"Wedging block", rom:"Hetchyo makgi",han:"해쵸 막기", dir:false, tool:false },
  { key:"nineshape",en:"9-shape block", rom:"Gutja makgi",  han:"구자 막기", dir:false, tool:false }
];

const DIR_ALLOWED = {
  block:["inward","outward","upward","downward","rising"],
  strike:["upward","downward"],
  punch:[],
  thrust:[],
  kick:[]
};

/* Stance constraints (editable to match your syllabus) */
const ALLOWED_STANCES = {
  block: {
    standard:  ["walking","l","sitting","fixed"],
    pressing:  ["walking","l"],
    sweeping:  ["l","walking"],
    checking:  ["l","walking"],
    guarding:  ["l","walking"],
    circular:  ["sitting","l"],
    wshape:    ["sitting"],
    ushape:    ["walking"],
    wedging:   ["sitting"],        // L-stance forbidden (your example)
    nineshape: ["walking"]
  },
  strike: { any: ["walking","l","sitting","fixed"] },
  punch:  { any: ["walking","l","fixed"] },
  thrust: { any: ["walking","l"] },
  kick:   { any: STANCES.map(s=>s.key) }
};

/* ================== STATE ================== */
const $ = id => document.getElementById(id);
const heightSel=$("heightSel"), stanceSel=$("stanceSel"), familySel=$("familySel");
const progressiveArea=$("progressiveArea");
const outEN=$("outEN"), outROM=$("outROM"), outHAN=$("outHAN");
const modFlyingWrap=$("modFlyingWrap"), modReverseWrap=$("modReverseWrap");
const modFlying=$("modFlying"), modReverse=$("modReverse");
const errorBox=$("errorBox");

const state = {
  heightKey:null,
  stanceKey:null,
  familyKey:null,
  // blocks
  blockTypeKey:null, blockToolKey:null, blockVarKey:null, blockDirKey:null,
  // strikes
  strikeToolKey:null, strikeDirKey:null,
  // punches
  punchStyleKey:null, punchToolKey:"forefist",
  // thrusts
  thrustStyleKey:null, thrustToolKey:null,
  // kicks
  kickTypeKey:null, kickFootKey:null,
  // modifiers
  mods:{ flying:false, reverse:false }
};

/* ================== HELPERS ================== */
function showError(msg){ if(!msg){ errorBox.classList.add("hidden"); errorBox.textContent=""; } else { errorBox.textContent=msg; errorBox.classList.remove("hidden"); } }
function option(label, value){ const o=document.createElement("option"); o.textContent=label; o.value=value; return o; }
function safeJoin(words, sep=" "){
  return words.filter(w => typeof w === "string" && w!=null && String(w).trim().length>0)
    .join(sep).replace(/\s+/g," ").trim();
}
const byKey = (arr,key)=>arr.find(x=>x.key===key)||null;

function fillSelectKeys(sel, items, labeler, keepValue){
  const chosen = sel.value;
  sel.innerHTML = "";
  sel.appendChild(option("Choose…",""));
  items.forEach(it=> sel.appendChild(option(labeler(it), it.key)));
  if(keepValue && items.some(it=>it.key===chosen)) sel.value=chosen;
}

/* ===== stance filtering ===== */
function stanceKeysForCurrent(){
  const fam = state.familyKey;
  if(!fam) return STANCES.map(s=>s.key);
  if(fam==="kick") return ALLOWED_STANCES.kick.any.slice();
  if(fam==="block"){
    const bt = state.blockTypeKey;
    if(!bt) return STANCES.map(s=>s.key);
    return (ALLOWED_STANCES.block[bt] || []);
  }
  if(fam==="strike") return ALLOWED_STANCES.strike.any.slice();
  if(fam==="punch")  return ALLOWED_STANCES.punch.any.slice();
  if(fam==="thrust") return ALLOWED_STANCES.thrust.any.slice();
  return STANCES.map(s=>s.key);
}
function refreshStance(){
  const keys = stanceKeysForCurrent();
  const list = STANCES.filter(s=>keys.includes(s.key));
  const was = state.stanceKey;
  fillSelectKeys(stanceSel, list, s=>`${s.en} — ${s.rom} — ${s.han} 서기`, true);
  if(was && !keys.includes(was)){ state.stanceKey=null; stanceSel.value=""; }
}

/* ===== modifiers ===== */
function refreshModifiers(){
  const flyingAllowed = (state.familyKey==="kick");
  modFlyingWrap.classList.toggle("hidden", !flyingAllowed);
  if(!flyingAllowed){ modFlying.checked=false; state.mods.flying=false; }

  const handFamily = ["punch","strike","thrust","block"].includes(state.familyKey||"");
  const reverseAllowed = handFamily && !!state.stanceKey;
  modReverseWrap.classList.toggle("hidden", !reverseAllowed);
  if(!reverseAllowed){ modReverse.checked=false; state.mods.reverse=false; }
}

/* ================== OUTPUT ================== */
function buildOutput(){
  const stanceObj = state.mods.flying && state.familyKey==="kick" ? null : byKey(STANCES, state.stanceKey);
  const H = byKey(HEIGHTS, state.heightKey);

  const mEN=[], mROM=[], mHAN=[];
  if(state.mods.flying && state.familyKey==="kick"){ mEN.push("Flying"); mROM.push("Twimyo"); mHAN.push("뛰며"); }
  const reverseOK = !!(stanceObj && ["punch","strike","thrust","block"].includes(state.familyKey||""));
  if(state.mods.reverse && reverseOK){ mEN.push("Reverse"); mROM.push("Bandae"); mHAN.push("반대"); }

  const H_en = H?.en||"", H_rom=H?.rom||"", H_han=H?.han||"";

  if(state.familyKey==="kick"){
    const kt = byKey(KICKS, state.kickTypeKey);
    if(!kt) return {en:"—",rom:"—",han:"—"};
    const foot = kt.feet.includes(state.kickFootKey) ? byKey(FOOT_TOOLS, state.kickFootKey) : null;

    let enCore = safeJoin([ mEN.join(" "), H_en, kt.en ]);
    let romCore= safeJoin([ mROM.join(" "), H_rom, kt.rom ]);
    let hanCore= safeJoin([ mHAN.join(" "), H_han, kt.han ]);
    if(foot){ enCore+=` (${foot.en})`; romCore+=` (${foot.rom})`; hanCore+=` (${foot.han})`; }
    return { en:enCore||"—", rom:romCore||"—", han:hanCore||"—" };
  }

  if(state.familyKey==="block"){
    const bt = byKey(BLOCK_TYPES, state.blockTypeKey);
    if(!bt) return {en:"—",rom:"—",han:"—"};

    // direction (only for certain types)
    let D=null;
    if(bt.dir && state.blockDirKey){
      const allowed = ["standard","sweeping","circular"].includes(bt.key) ? DIR_ALLOWED.block : [];
      if(allowed.includes(state.blockDirKey)) D = byKey(DIR_ALL, state.blockDirKey);
    }

    // tool phrase
    let tp = {en:"",rom:"",han:""};
    if(bt.tool){
      const allowedBases = bt.allowedTools||[];
      if(state.blockToolKey && allowedBases.includes(state.blockToolKey)){
        // map base + variant -> phrase
        const base = byKey(BLOCK_TOOL_BASES, state.blockToolKey);
        const v = base?.variants?.find(v=>v.key===state.blockVarKey) || null;

        if(base?.key==="forearm"){
          if(!v) tp={en:"Forearm", rom:"Palmok", han:"팔목"};
          else if(v.key==="inner") tp={en:"Inner forearm", rom:"An palmok", han:"안 팔목"};
          else if(v.key==="outer") tp={en:"Outer forearm", rom:"Bakat palmok", han:"바깥 팔목"};
        }else if(base?.key==="knifehand"){
          if(!v || v.key==="normal") tp={en:"Knifehand", rom:"Sonkal", han:"손칼"};
          else if(v.key==="reverse") tp={en:"Reverse knifehand", rom:"Sonkal dung", han:"손칼 등"};
        }else if(base?.key==="palm"){
          if(!v || v.key==="normal") tp={en:"Palm", rom:"Sonbadak", han:"손바닥"};
          else if(v.key==="reverse") tp={en:"Reverse palm", rom:"Sonbadak dung", han:"손바닥 등"};
        }else if(base?.key==="fist"){
          tp={en:"Fist", rom:"Joomuk", han:"주먹"};
        }
      }
    }

    let enAct = bt.en, romAct=bt.rom, hanAct=bt.han;
    if(bt.key==="guarding" && tp.en){
      if(tp.en.startsWith("Forearm")){ romAct="Palmok daebi makgi"; hanAct="팔목 대비 막기"; }
      if(tp.en.startsWith("Knifehand")){ romAct="Sonkal daebi makgi"; hanAct="손칼 대비 막기"; }
    }
    if(bt.key==="pressing" && tp.en==="Fist"){
      enAct="X-fist pressing block"; romAct="Kyocha joomuk noollo makgi"; hanAct="교차 주먹 눌러 막기";
      tp={en:"",rom:"",han:""};
    }

    const enCore = safeJoin([ mEN.join(" "), H_en, D?.en||"", tp.en||"", enAct ]);
    const romCore= safeJoin([ mROM.join(" "), H_rom, D?.rom||"", tp.rom||"", romAct ]);
    const hanCore= safeJoin([ mHAN.join(" "), H_han, D?.han||"", tp.han||"", hanAct ]);

    const en = safeJoin([ stanceObj ? (stanceObj.en+" stance") : "", ",", enCore ], " ");
    const rom = safeJoin([ stanceObj ? (stanceObj.rom+" sogi") : "", romCore ], ", ");
    const han = safeJoin([ stanceObj ? (stanceObj.han+" 서기")  : "", hanCore ], ", ");
    return { en, rom, han };
  }

  if(state.familyKey==="strike"){
    const tool = byKey(STRIKE_TOOLS, state.strikeToolKey);
    if(!tool) return {en:"—",rom:"—",han:"—"};
    const dirAllowed = DIR_ALLOWED.strike;
    const D = state.strikeDirKey && dirAllowed.includes(state.strikeDirKey) ? byKey(DIR_ALL, state.strikeDirKey) : null;

    const enCore = safeJoin([ (state.mods.reverse && stanceObj) ? "Reverse" : "", H_en, D?.en||"", tool.en+" strike" ]);
    const romCore= safeJoin([ (state.mods.reverse && stanceObj) ? "Bandae" : "", H_rom, D?.rom||"", tool.rom, "taerigi" ]);
    const hanCore= safeJoin([ (state.mods.reverse && stanceObj) ? "반대" : "", H_han, D?.han||"", tool.han, "때리기" ]);

    const en = safeJoin([ stanceObj ? (stanceObj.en+" stance") : "", ",", enCore ], " ");
    const rom = safeJoin([ stanceObj ? (stanceObj.rom+" sogi") : "", romCore ], ", ");
    const han = safeJoin([ stanceObj ? (stanceObj.han+" 서기")  : "", hanCore ], ", ");
    return { en, rom, han };
  }

  if(state.familyKey==="punch"){
    const sty = byKey(PUNCH_STYLES, state.punchStyleKey);
    const tool = byKey(PUNCH_TOOLS, state.punchToolKey);
    if(!sty || !tool) return {en:"—",rom:"—",han:"—"};

    const enCore = safeJoin([ (state.mods.reverse && stanceObj) ? "Reverse" : "", H_en, tool.en, sty.en ]);
    const romCore= safeJoin([ (state.mods.reverse && stanceObj) ? "Bandae" : "", H_rom, tool.rom, sty.rom ]);
    const hanCore= safeJoin([ (state.mods.reverse && stanceObj) ? "반대" : "", H_han, tool.han, sty.han ]);
    const en = safeJoin([ stanceObj ? (stanceObj.en+" stance") : "", ",", enCore ], " ");
    const rom = safeJoin([ stanceObj ? (stanceObj.rom+" sogi") : "", romCore ], ", ");
    const han = safeJoin([ stanceObj ? (stanceObj.han+" 서기")  : "", hanCore ], ", ");
    return { en, rom, han };
  }

  if(state.familyKey==="thrust"){
    const sty = byKey(THRUST_STYLES, state.thrustStyleKey);
    const tool = byKey(THRUST_TOOLS, state.thrustToolKey);
    if(!sty || !tool) return {en:"—",rom:"—",han:"—"};

    const enCore = safeJoin([ (state.mods.reverse && stanceObj) ? "Reverse" : "", H_en, tool.en, sty.en ]);
    const romCore= safeJoin([ (state.mods.reverse && stanceObj) ? "Bandae" : "", H_rom, tool.rom, sty.rom ]);
    const hanCore= safeJoin([ (state.mods.reverse && stanceObj) ? "반대" : "", H_han, tool.han, sty.han ]);
    const en = safeJoin([ stanceObj ? (stanceObj.en+" stance") : "", ",", enCore ], " ");
    const rom = safeJoin([ stanceObj ? (stanceObj.rom+" sogi") : "", romCore ], ", ");
    const han = safeJoin([ stanceObj ? (stanceObj.han+" 서기")  : "", hanCore ], ", ");
    return { en, rom, han };
  }

  return {en:"—",rom:"—",han:"—"};
}

/* ================== UI (CASCADING) ================== */
function clearProgressive(){ progressiveArea.innerHTML=""; }
function addStepKeys(id, labelText, items, labeler, onChange, initialKey=null){
  const wrap=document.createElement("div"); wrap.className="step"; wrap.id=id+"Wrap";
  const lab=document.createElement("label"); lab.textContent=labelText; wrap.appendChild(lab);
  const sel=document.createElement("select"); sel.id=id; sel.appendChild(option("Choose…",""));
  items.forEach(it=> sel.appendChild(option(labeler(it), it.key)));
  if(initialKey) sel.value=initialKey;
  sel.onchange = onChange;
  wrap.appendChild(sel);
  progressiveArea.appendChild(wrap);
  return sel;
}

function rebuildProgressive(){
  clearProgressive();
  if(!state.familyKey){ refreshStance(); return; }

  if(state.familyKey==="block"){
    addStepKeys("blockTypeSel","Block type", BLOCK_TYPES, b=>`${b.en} — ${b.rom} — ${b.han}`, e=>{
      state.blockTypeKey = e.target.value || null;
      state.blockToolKey = state.blockVarKey = state.blockDirKey = null;
      refreshStance(); rebuildProgressive(); safeRender();
    }, state.blockTypeKey);

    const bt = byKey(BLOCK_TYPES, state.blockTypeKey);
    if(!bt){ refreshStance(); return; }

    if(bt.tool){
      const toolBases = BLOCK_TOOL_BASES.filter(t=>bt.allowedTools.includes(t.key));
      addStepKeys("blockToolSel","Tool", toolBases, t=>`${t.en} — ${t.rom} — ${t.han}`, e=>{
        state.blockToolKey = e.target.value || null;
        state.blockVarKey = null;
        rebuildProgressive(); safeRender();
      }, state.blockToolKey);

      const base = byKey(BLOCK_TOOL_BASES, state.blockToolKey);
      if(base && (base.variants||[]).length){
        addStepKeys("blockVarSel","Tool variant", base.variants, v=>v.en||"(default)", e=>{
          state.blockVarKey = e.target.value || null;
          safeRender();
        }, state.blockVarKey);
      }
    }

    if(bt.dir){
      const dirKeys = DIR_ALLOWED.block;
      const dirs = DIR_ALL.filter(d=>dirKeys.includes(d.key));
      addStepKeys("blockDirSel","Direction", dirs, d=>`${d.en} — ${d.rom} — ${d.han}`, e=>{
        state.blockDirKey = e.target.value || null;
        safeRender();
      }, state.blockDirKey);
    }

    refreshStance();
  }

  if(state.familyKey==="strike"){
    addStepKeys("strikeToolSel","Strike tool", STRIKE_TOOLS, t=>`${t.en} — ${t.rom} — ${t.han}`, e=>{
      state.strikeToolKey = e.target.value || null;
      rebuildProgressive(); safeRender();
    }, state.strikeToolKey);

    const dirs = DIR_ALL.filter(d=>DIR_ALLOWED.strike.includes(d.key));
    addStepKeys("strikeDirSel","Direction", dirs, d=>`${d.en} — ${d.rom} — ${d.han}`, e=>{
      state.strikeDirKey = e.target.value || null;
      safeRender();
    }, state.strikeDirKey);

    refreshStance();
  }

  if(state.familyKey==="punch"){
    addStepKeys("punchStyleSel","Punch style", PUNCH_STYLES, p=>`${p.en} — ${p.rom} — ${p.han}`, e=>{
      state.punchStyleKey = e.target.value || null;
      rebuildProgressive(); safeRender();
    }, state.punchStyleKey);

    addStepKeys("punchToolSel","Tool", PUNCH_TOOLS, t=>`${t.en} — ${t.rom} — ${t.han}`, e=>{
      state.punchToolKey = e.target.value || null;
      safeRender();
    }, state.punchToolKey);

    refreshStance();
  }

  if(state.familyKey==="thrust"){
    addStepKeys("thrustStyleSel","Thrust style", THRUST_STYLES, t=>`${t.en} — ${t.rom} — ${t.han}`, e=>{
      state.thrustStyleKey = e.target.value || null;
      rebuildProgressive(); safeRender();
    }, state.thrustStyleKey);

    addStepKeys("thrustToolSel","Tool", THRUST_TOOLS, t=>`${t.en} — ${t.rom} — ${t.han}`, e=>{
      state.thrustToolKey = e.target.value || null;
      safeRender();
    }, state.thrustToolKey);

    refreshStance();
  }

  if(state.familyKey==="kick"){
    addStepKeys("kickTypeSel","Kick", KICKS, k=>`${k.en} — ${k.rom} — ${k.han}`, e=>{
      state.kickTypeKey = e.target.value || null;
      state.kickFootKey = null;
      rebuildProgressive(); safeRender();
    }, state.kickTypeKey);

    const kt = byKey(KICKS, state.kickTypeKey);
    if(kt){
      const feet = FOOT_TOOLS.filter(f=>kt.feet.includes(f.key));
      if(feet.length){
        addStepKeys("kickFootSel","Foot tool", feet, f=>`${f.en} — ${f.rom} — ${f.han}`, e=>{
          state.kickFootKey = e.target.value || null;
          safeRender();
        }, state.kickFootKey);
      }
    }

    refreshStance();
  }
}

/* ================== INIT & RENDER ================== */
function safeRender(){
  try{
    showError(null);
    const out = buildOutput();
    outEN.textContent = out.en || "—";
    outROM.textContent = out.rom || "—";
    outHAN.textContent = out.han || "—";
  }catch(err){
    console.error(err);
    showError("Error: "+(err?.message||String(err)));
    outEN.textContent = outROM.textContent = outHAN.textContent = "—";
  }
}

function init(){
  // Height
  fillSelectKeys(heightSel, HEIGHTS, h=>`${h.en} — ${h.rom} — ${h.han}`, false);
  heightSel.onchange = e => { state.heightKey = e.target.value || null; safeRender(); };

  // Stance (all initially)
  fillSelectKeys(stanceSel, STANCES, s=>`${s.en} — ${s.rom} — ${s.han} 서기`, false);
  stanceSel.onchange = e => { state.stanceKey = e.target.value || null; refreshModifiers(); safeRender(); };

  // Families
  [
    {key:"block", label:"Block"},
    {key:"strike",label:"Strike"},
    {key:"punch", label:"Punch"},
    {key:"thrust",label:"Thrust"},
    {key:"kick",  label:"Kick"}
  ].forEach(f=> familySel.appendChild(option(f.label, f.key)));
  familySel.onchange = e => {
    state.familyKey = e.target.value || null;

    // Reset dependents
    state.blockTypeKey = state.blockToolKey = state.blockVarKey = state.blockDirKey = null;
    state.strikeToolKey = state.strikeDirKey = null;
    state.punchStyleKey = null; state.punchToolKey="forefist";
    state.thrustStyleKey = state.thrustToolKey = null;
    state.kickTypeKey = state.kickFootKey = null;
    state.mods.flying=false; state.mods.reverse=false;
    modFlying.checked=false; modReverse.checked=false;

    rebuildProgressive(); refreshModifiers(); refreshStance(); safeRender();
  };

  // Modifiers
  modFlying.onchange = () => { state.mods.flying = modFlying.checked; refreshStance(); safeRender(); };
  modReverse.onchange = () => { state.mods.reverse = modReverse.checked; safeRender(); };

  rebuildProgressive(); refreshModifiers(); refreshStance(); safeRender();
}

window.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>